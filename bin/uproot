#!/bin/bash
# update-filesystem.squashfs - Update filesystem.squashfs from overlay filesystem

set -e

echo "Updating filesystem.squashfs..."

# Remount /cdrom as read-write
mount /cdrom -o remount,rw

# Create overlay filesystem directories
mkdir -p /tmp/squashfs/upper/ /tmp/squashfs/work/ /tmp/squashfs/root/

# Mount overlay filesystem (unmount first if already mounted)
if mountpoint -q /tmp/squashfs/root/ 2>/dev/null; then
    echo "Unmounting existing overlay..."
    umount /tmp/squashfs/root/ || true
fi

mount -t overlay overlay -o upperdir=/tmp/squashfs/upper/,lowerdir=/rofs,workdir=/tmp/squashfs/work/ /tmp/squashfs/root/

# Bind mount apt cache for package installations
mount --bind /var/cache/apt/archives/ /tmp/squashfs/root/var/cache/apt/archives/ || true

# Copy resolv.conf for network access
cp /etc/resolv.conf /tmp/squashfs/root/etc/resolv.conf || true

# Backup existing filesystem.squashfs
#if [ -f /cdrom/casper/filesystem.squashfs ]; then
#    mv /cdrom/casper/filesystem.squashfs /cdrom/casper/filesystem_$(date +%Y%m%d%H%M%S).squashfs
#fi

#is empty /tmp/squashfs/upper/
if [ -z "$(ls -A /tmp/squashfs/upper/)" ]; then
    echo "Upper directory is empty, skipping filesystem.squashfs update"
    exit 0
fi

# Create new filesystem.squashfs
mksquashfs /tmp/squashfs/root/ /cdrom/casper/filesystem_new.squashfs -comp zstd -Xcompression-level 22

mv /cdrom/casper/filesystem.squashfs /cdrom/casper/filesystem_`date +%Y%m%d%H%M%S`.squashfs
mv /cdrom/casper/filesystem_new.squashfs /cdrom/casper/filesystem.squashfs


echo "filesystem.squashfs updated successfully!"
